<div class="space-y-6">
  <div *ngIf="usersLoading" class="text-center py-12">
    <div class="animate-spin rounded-full h-10 w-10 border-b-2 border-red-500 mx-auto"></div>
  </div>
  <div *ngIf="!usersLoading && users.length > 0" class="bg-white dark:bg-slate-800 rounded-lg shadow overflow-hidden">
    <div class="overflow-x-auto max-w-full">
      <table class="w-full text-left text-sm min-w-[900px]">
        <thead>
          <tr class="text-slate-500 dark:text-slate-400 border-b border-slate-200 dark:border-slate-700 bg-slate-50 dark:bg-slate-800/50">
            <th class="px-4 py-3">Username</th>
            <th class="px-4 py-3">Email</th>
            <th class="px-4 py-3">Role</th>
            <th class="px-4 py-3">Status</th>
            <th class="px-4 py-3">Last IP</th>
            <th class="px-4 py-3">Team</th>
            <th class="px-4 py-3">Last Login</th>
            <th class="px-4 py-3">Actions</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let user of users" class="border-b border-slate-100 dark:border-slate-700/50 hover:bg-slate-50 dark:hover:bg-slate-800/50 cursor-pointer" (click)="viewUserDetails(user)">
            <td class="px-4 py-3 font-medium text-slate-900 dark:text-white">
              <div class="flex items-center gap-2">
                {{ user.username }}
                <span *ngIf="user.oauth_provider" class="text-xs px-1.5 py-0.5 bg-blue-100 dark:bg-blue-900/30 text-blue-600 dark:text-blue-400 rounded">{{ user.oauth_provider }}</span>
                <span *ngIf="user.email_verified" class="text-green-500" title="Email verified">âœ“</span>
              </div>
            </td>
            <td class="px-4 py-3 text-slate-600 dark:text-slate-400">{{ user.email }}</td>
            <td class="px-4 py-3">
              <span [class]="user.role === 'admin' ? 'text-red-600 dark:text-red-400 font-semibold' : 'text-slate-600 dark:text-slate-400'">
                {{ user.role }}
              </span>
            </td>
            <td class="px-4 py-3">
              <span class="px-2 py-1 rounded-full text-xs" [class]="{
                'bg-green-100 text-green-700 dark:bg-green-900/30 dark:text-green-400': user.status === 'active' || !user.status,
                'bg-red-100 text-red-700 dark:bg-red-900/30 dark:text-red-400': user.status === 'banned',
                'bg-yellow-100 text-yellow-700 dark:bg-yellow-900/30 dark:text-yellow-400': user.status === 'suspended'
              }">
                {{ user.status || 'active' }}
              </span>
            </td>
            <td class="px-4 py-3 text-slate-600 dark:text-slate-400 font-mono text-xs">
              {{ user.last_ip || '-' }}
            </td>
            <td class="px-4 py-3 text-slate-600 dark:text-slate-400">
              <span *ngIf="user.team_name" class="text-xs px-2 py-1 bg-indigo-100 dark:bg-indigo-900/30 text-indigo-700 dark:text-indigo-300 rounded">{{ user.team_name }}</span>
              <span *ngIf="!user.team_name" class="text-slate-400">-</span>
            </td>
            <td class="px-4 py-3 text-slate-600 dark:text-slate-400 text-xs">
              {{ user.last_login_at ? (user.last_login_at | date:'short') : '-' }}
            </td>
            <td class="px-4 py-3" (click)="$event.stopPropagation()">
              <div class="flex gap-2 flex-wrap">
                <button *ngIf="user.role !== 'admin'" (click)="updateUserRole(user.id, 'admin')" class="text-xs px-2 py-1 bg-indigo-100 dark:bg-indigo-900/30 text-indigo-700 dark:text-indigo-300 rounded hover:bg-indigo-200 dark:hover:bg-indigo-900/50">Admin</button>
                <button *ngIf="user.role === 'admin'" (click)="updateUserRole(user.id, 'user')" class="text-xs px-2 py-1 bg-slate-100 dark:bg-slate-700 text-slate-700 dark:text-slate-300 rounded hover:bg-slate-200 dark:hover:bg-slate-600">Demote</button>
                <button *ngIf="user.status !== 'banned'" (click)="updateUserStatus(user.id, 'banned')" class="text-xs px-2 py-1 bg-red-100 dark:bg-red-900/30 text-red-700 dark:text-red-300 rounded hover:bg-red-200 dark:hover:bg-red-900/50">Ban</button>
                <button *ngIf="user.status === 'banned'" (click)="updateUserStatus(user.id, 'active')" class="text-xs px-2 py-1 bg-green-100 dark:bg-green-900/30 text-green-700 dark:text-green-300 rounded hover:bg-green-200 dark:hover:bg-green-900/50">Unban</button>
              </div>
            </td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>

  <!-- User Details Panel -->
  <div *ngIf="selectedUser" class="bg-white dark:bg-slate-800 rounded-lg shadow p-6">
    <div class="flex justify-between items-start mb-4">
      <h3 class="text-lg font-semibold text-slate-900 dark:text-white">User Details: {{ selectedUser.username }}</h3>
      <button (click)="selectedUser = null" class="text-slate-400 hover:text-slate-600 dark:hover:text-slate-300">
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
      </button>
    </div>
    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
      <div>
        <p class="text-sm text-slate-500 dark:text-slate-400">Email</p>
        <p class="text-slate-900 dark:text-white">{{ selectedUser.email }}</p>
      </div>
      <div>
        <p class="text-sm text-slate-500 dark:text-slate-400">Role</p>
        <p class="text-slate-900 dark:text-white">{{ selectedUser.role }}</p>
      </div>
      <div>
        <p class="text-sm text-slate-500 dark:text-slate-400">Created At</p>
        <p class="text-slate-900 dark:text-white">{{ selectedUser.created_at | date:'medium' }}</p>
      </div>
      <div>
        <p class="text-sm text-slate-500 dark:text-slate-400">Last Login</p>
        <p class="text-slate-900 dark:text-white">{{ selectedUser.last_login_at ? (selectedUser.last_login_at | date:'medium') : 'Never' }}</p>
      </div>
      <div>
        <p class="text-sm text-slate-500 dark:text-slate-400">Last IP</p>
        <p class="text-slate-900 dark:text-white font-mono">{{ selectedUser.last_ip || 'Unknown' }}</p>
      </div>
      <div>
        <p class="text-sm text-slate-500 dark:text-slate-400">Team</p>
        <p class="text-slate-900 dark:text-white">{{ selectedUser.team_name || 'No team' }}</p>
      </div>
      <div *ngIf="selectedUser.ban_reason">
        <p class="text-sm text-slate-500 dark:text-slate-400">Ban Reason</p>
        <p class="text-red-600 dark:text-red-400">{{ selectedUser.ban_reason }}</p>
      </div>
    </div>

    <!-- IP History -->
    <div *ngIf="selectedUser.ip_history && selectedUser.ip_history.length > 0" class="mt-4">
      <h4 class="text-sm font-semibold text-slate-900 dark:text-white mb-2">IP History (Last 50)</h4>
      <div class="max-h-48 overflow-y-auto bg-slate-50 dark:bg-slate-900/50 rounded p-3">
        <table class="w-full text-sm">
          <thead>
            <tr class="text-slate-500 dark:text-slate-400">
              <th class="text-left pb-2">IP Address</th>
              <th class="text-left pb-2">Action</th>
              <th class="text-left pb-2">Time</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let ip of selectedUser.ip_history" class="border-t border-slate-200 dark:border-slate-700">
              <td class="py-1 font-mono text-slate-700 dark:text-slate-300">{{ ip.ip }}</td>
              <td class="py-1 text-slate-600 dark:text-slate-400">{{ ip.action || '-' }}</td>
              <td class="py-1 text-slate-600 dark:text-slate-400">{{ ip.timestamp | date:'short' }}</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>

    <!-- Manual User Score Adjustment -->
    <div class="mt-6 border-t border-slate-200 dark:border-slate-700 pt-4">
      <h4 class="text-sm font-semibold text-slate-900 dark:text-white mb-3">Adjust User Score</h4>
      <div class="flex flex-col md:flex-row gap-3 items-start md:items-end">
        <div>
          <label class="block text-xs font-medium text-slate-500 dark:text-slate-400 mb-1">
            Delta (use negative value to deduct)
          </label>
          <input type="number"
                 [(ngModel)]="userScoreDelta"
                 class="px-3 py-2 rounded-lg border border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-900 text-slate-900 dark:text-white text-sm focus:ring-2 focus:ring-red-500 focus:border-red-500 w-32">
        </div>
        <div class="flex-1 w-full">
          <label class="block text-xs font-medium text-slate-500 dark:text-slate-400 mb-1">
            Reason (optional)
          </label>
          <input type="text"
                 [(ngModel)]="userScoreReason"
                 placeholder="e.g. bonus, penalty, manual correction"
                 class="px-3 py-2 rounded-lg border border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-900 text-slate-900 dark:text-white text-sm focus:ring-2 focus:ring-red-500 focus:border-red-500 w-full">
        </div>
        <button (click)="applyUserScoreAdjustment()"
                class="px-4 py-2 text-sm font-semibold bg-red-600 text-white rounded-lg hover:bg-red-700 disabled:opacity-60 disabled:cursor-not-allowed">
          Apply
        </button>
      </div>
      <p class="mt-2 text-xs text-slate-500 dark:text-slate-400">
        This affects the individual scoreboard and analytics; it does not create a challenge solve.
      </p>
    </div>
  </div>
</div>
